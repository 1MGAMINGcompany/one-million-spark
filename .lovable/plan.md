

# Fix Quick Match Settlement: Auto-Payout for All Staked Games

## Problem

Three game pages (Chess, Dominos, Ludo) are missing the `useAutoSettlement` hook, which means staked Quick Match games won't automatically pay the winner. Additionally, `isStaked` is hardcoded to `false` in Chess and Ludo, so even the manual "Claim Payout" button won't appear.

The correct flow (as seen in Backgammon and Checkers): when a game ends, `useAutoSettlement` auto-calls the `settle-game` edge function, which handles winner derivation server-side, signs the on-chain payout, and upserts `match_share_cards` -- all without any wallet popup or manual action from the winner.

## What Works Already (No Changes)

- Auto-forfeits (3 missed turns): server-triggered via `game-session-get` polling
- Manual forfeit: via `useForfeit` hook (all games have this)
- Match share cards: generated by `settle-game` / `forfeit-game` edge functions
- Share card UI: `GameEndScreen` links to `/match/:roomPda`

## Changes

### 1. `src/pages/ChessGame.tsx`

**A. Add `useAutoSettlement` hook** (same pattern as Checkers/Backgammon):
- Import `useAutoSettlement` from `@/hooks/useAutoSettlement`
- Call it with `{ roomPda, winner: winnerAddress, reason: "gameover", isRanked: isRankedGame }`
- Add settlement toast effect (success/error) matching Checkers pattern

**B. Fix `isStaked` prop on `GameEndScreen`**:
- Change `isStaked={false}` to `isStaked={isRankedGame}` (line 1395)
- This matches the Checkers pattern exactly

**C. Add settling overlay** (optional but matches Checkers):
- Show "Settling on-chain..." overlay while `autoSettlement.isSettling` is true

### 2. `src/pages/DominosGame.tsx`

**A. Add `useAutoSettlement` hook**:
- Import and call with same pattern
- Add settlement toast effect
- `isStaked` is already correctly set to `entryFeeSol > 0` (line 1677), but should also check `isRankedGame` for consistency: `isStaked={isRankedGame || entryFeeSol > 0}`

**B. Add settling overlay**

### 3. `src/pages/LudoGame.tsx`

**A. Add `useAutoSettlement` hook**:
- Import and call with same pattern
- Add settlement toast effect

**B. Fix `isStaked` prop on `GameEndScreen`**:
- Change `isStaked={false}` to `isStaked={isRankedGame}` (line 1236)

**C. Add settling overlay**

## Technical Details

- `useAutoSettlement` is idempotent: it checks `hasAttemptedRef` to prevent double-calls, and `settle-game` checks `finalize_receipts` server-side
- The hook auto-fires via `useEffect` when `winner` transitions from null to a wallet address
- `settle-game` derives the winner from `game_state` in the DB + on-chain `players[]` array -- no client input needed
- Winner receives SOL automatically (minus 5% fee), room creator gets vault rent back
- `match_share_cards` is upserted by `settle-game`, enabling the brag/share link at `/match/:roomPda`
- No wallet popup -- the verifier key signs server-side

## Files Modified

| File | Change |
|------|--------|
| `src/pages/ChessGame.tsx` | Add `useAutoSettlement`, fix `isStaked`, add settling overlay |
| `src/pages/DominosGame.tsx` | Add `useAutoSettlement`, update `isStaked`, add settling overlay |
| `src/pages/LudoGame.tsx` | Add `useAutoSettlement`, fix `isStaked`, add settling overlay |

